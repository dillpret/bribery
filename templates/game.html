<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="game-id" content="{{ game_id }}">
    <title>Bribery Game - {{ game_id }}</title>
    <link rel="stylesheet" href="{{ versioned_static('css/game.css') }}">
    <link rel="stylesheet" href="{{ versioned_static('css/components/progress-indicators.css') }}">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ versioned_static('images/logo/favicon-96x96.png') }}" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="{{ versioned_static('images/logo/favicon.svg') }}" />
    <link rel="shortcut icon" href="{{ versioned_static('images/logo/favicon.ico') }}" />
    <link rel="apple-touch-icon" sizes="180x180" href="{{ versioned_static('images/logo/apple-touch-icon.png') }}" />
    <meta name="apple-mobile-web-app-title" content="Bribery" />
    <!-- Prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Preload critical assets -->
    <link rel="preload" href="{{ versioned_static('images/logo/logo-full.png') }}" as="image">
    <!-- Image loading optimizations -->
    <link rel="stylesheet" href="{{ versioned_static('css/components/image-loading.css') }}">
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="logo-wrapper">
                <!-- Optimized logo loading with SVG fallback -->
                <img src="{{ versioned_static('images/logo/logo-full.png') }}" alt="Bribery Game" class="hero-logo" 
                     loading="eager" fetchpriority="high" onerror="this.classList.add('error')">
                <h1 class="hero-logo-fallback">üéØ Bribery</h1>
            </div>
            <div class="game-info">
                Game ID: <strong>{{ game_id }}</strong>
                <span id="connection-status" class="connection-status connected" title="Connection Status"></span>
            </div>
        </div>

        <div class="status-bar">
            <div id="game-status">Connecting...</div>
            <div id="timer" class="timer hidden"></div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby" class="hidden">
            <div class="lobby-content">
                <h2>Waiting for Players</h2>
                <div class="player-list" id="player-list"></div>
                <div class="settings-display" id="settings-display"></div>
                
                <!-- Host Settings Controls (only visible to host) -->
                <div id="host-settings" class="hidden">
                    <h3>Game Settings</h3>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label for="rounds">Number of Rounds:</label>
                            <input type="number" id="rounds" min="1" max="100" value="3" placeholder="3">
                        </div>
                        <div class="form-group">
                            <label for="submission-time-mode">Submission Time:</label>
                            <div class="time-input-container">
                                <select id="submission-time-mode">
                                    <option value="off">Off - Wait for all players</option>
                                    <option value="timed">Timed</option>
                                </select>
                                <div id="submission-time-controls" class="time-controls hidden">
                                    <input type="number" id="submission-time-value" min="1" max="999" value="2" placeholder="2">
                                    <select id="submission-time-unit">
                                        <option value="minutes">Minutes</option>
                                        <option value="seconds">Seconds</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="voting-time-mode">Voting Time:</label>
                            <div class="time-input-container">
                                <select id="voting-time-mode">
                                    <option value="off">Off - Wait for all players</option>
                                    <option value="timed">Timed</option>
                                </select>
                                <div id="voting-time-controls" class="time-controls hidden">
                                    <input type="number" id="voting-time-value" min="1" max="999" value="60" placeholder="60">
                                    <select id="voting-time-unit">
                                        <option value="seconds">Seconds</option>
                                        <option value="minutes">Minutes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="results-time-mode">Results Screen Time:</label>
                            <div class="time-input-container">
                                <select id="results-time-mode">
                                    <option value="off">Off - Host controls next round</option>
                                    <option value="timed">Timed</option>
                                </select>
                                <div id="results-time-controls" class="time-controls hidden">
                                    <input type="number" id="results-time-value" min="1" max="999" value="15" placeholder="15">
                                    <select id="results-time-unit">
                                        <option value="seconds">Seconds</option>
                                        <option value="minutes">Minutes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="prompt-selection-time-mode">Prompt Selection Time:</label>
                            <div class="time-input-container">
                                <select id="prompt-selection-time-mode">
                                    <option value="off" selected>Off - Wait for all players</option>
                                    <option value="timed">Timed</option>
                                </select>
                                <div id="prompt-selection-time-controls" class="time-controls hidden">
                                    <input type="number" id="prompt-selection-time-value" min="1" max="999" value="30" placeholder="30">
                                    <select id="prompt-selection-time-unit">
                                        <option value="seconds" selected>Seconds</option>
                                        <option value="minutes">Minutes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="custom-prompts">Custom Prompts:</label>
                            <select id="custom-prompts">
                                <option value="true">Enabled - Each player chooses their own</option>
                                <option value="false">Disabled - Same prompt for all</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="updateSettings()" class="settings-update-btn">Update Settings</button>
                </div>
                
                <div id="host-controls" class="hidden">
                    <button id="start-game-btn" onclick="startGame()" disabled>Start Game</button>
                </div>
                <p style="margin-top: 20px; color: #666;">
                    Share the Game ID <strong>{{ game_id }}</strong> with your friends to join!
                </p>
            </div>
        </div>

        <!-- Prompt Selection Phase -->
        <div id="prompt-selection" class="hidden">
            <div class="round-header">
                <h2 id="prompt-round-title" class="round-title"></h2>
                <div class="phase-indicator">
                    <span class="phase-badge phase-1">Phase 1 of 4:</span> Prompt Selection
                </div>
                <div class="phase-explanation">
                    <p class="instruction">
                        <strong>Choose a prompt that other players will use when bribing you.</strong><br>
                        This is what two other players will respond to when trying to win your point!
                    </p>
                </div>
                <div id="prompt-selection-progress" class="progress-indicator">
                    <p id="prompt-selection-progress-text">0/0 players selected prompts</p>
                </div>
            </div>

            <div class="phase-content">
                <div class="prompt-selector">
                    <div class="prompt-option-section">
                        <h3>Option 1: Choose from suggested prompts:</h3>
                        <select id="prompt-dropdown" onchange="onPromptDropdownChange()">
                            <option value="">Select a prompt...</option>
                        </select>
                    </div>

                    <div class="prompt-divider">
                        <span>OR</span>
                    </div>

                    <div class="prompt-option-section">
                        <h3>Option 2: Type your own custom prompt:</h3>
                        <textarea id="custom-prompt-input" placeholder="Enter your custom prompt here..."
                            maxlength="200"></textarea>
                    </div>

                    <button id="confirm-prompt-btn" onclick="selectPrompt()" class="primary-button" disabled>
                        Confirm Prompt
                    </button>
                </div>

                <div class="help-text">
                    <p><strong>Tip:</strong> Choose a prompt that will inspire creative and funny bribes! Examples: "The best way to spend a weekend," "Something that would convince me to give you my last cookie," etc.</p>
                </div>
            </div>
        </div>

        <!-- Submission Phase -->
        <div id="submission-phase" class="hidden">
            <div class="round-header">
                <h2 id="round-title" class="round-title"></h2>
                <div class="phase-indicator">
                    <span class="phase-badge phase-2">Phase 2 of 4:</span> Bribery Creation
                </div>
                <div class="phase-explanation">
                    <p class="instruction">
                        <strong>Create bribes to win points from other players!</strong><br>
                        Respond to each player's prompt with something creative and convincing.
                    </p>
                </div>
                <div id="submission-progress" class="progress-indicator">
                    <p id="submission-progress-text">0/0 players finished</p>
                </div>
            </div>
            <div class="phase-content">
                <div class="prompt" id="current-prompt"></div>
                <div id="targets-container" class="targets-container"></div>
            </div>
        </div>

        <!-- Voting Phase -->
        <div id="voting-phase" class="hidden">
            <div class="round-header">
                <h2 class="round-title">Time to Vote!</h2>
                <div class="phase-indicator">
                    <span class="phase-badge phase-3">Phase 3 of 4:</span> Voting
                </div>
                <div class="phase-explanation">
                    <p class="instruction">
                        <strong>Choose your favourite bribe!</strong><br>
                        Two players have created bribes based on your prompt. Vote for the one you like best.
                    </p>
                </div>
                <div id="voting-progress" class="progress-indicator">
                    <p id="voting-progress-text">0/0 players voted</p>
                </div>
            </div>
            <div class="phase-content">
                <div class="player-prompt-container">
                    <h3>Your prompt was:</h3>
                    <div id="voting-player-prompt" class="player-prompt"></div>
                </div>
                <p class="voting-instruction">Choose your favourite bribe submission:</p>
                <div id="voting-options" class="voting-options"></div>
                <button id="submit-vote-btn" onclick="submitVote()" class="primary-button" disabled>Submit Vote</button>
            </div>
        </div>

        <!-- Scoreboard -->
        <div id="scoreboard-phase" class="hidden">
            <div class="round-header">
                <h2 id="scoreboard-title" class="round-title"></h2>
                <div class="phase-indicator">
                    <span class="phase-badge phase-4">Phase 4 of 4:</span> Round Results
                </div>
                <div class="phase-explanation">
                    <p class="instruction">
                        <strong>See who won points this round!</strong><br>
                        The winning bribes for each prompt are shown below.
                    </p>
                </div>
            </div>
            <div class="phase-content">
                <div id="vote-results" class="vote-results"></div>
                <div class="scoreboard" id="scoreboard"></div>
                <div id="host-round-controls" class="host-controls hidden">
                    <button id="next-round-btn" onclick="socket.emit('next_round')" class="primary-button">Continue to Next Round</button>
                </div>
            </div>
        </div>

        <!-- Final Results -->
        <div id="final-results" class="hidden">
            <div class="round-info">
                <h2>üèÜ Final Results üèÜ</h2>
            </div>
            <div class="scoreboard" id="final-scoreboard"></div>
            <div id="host-final-controls" class="hidden">
                <button onclick="returnToLobby()" class="primary-button">Return to Lobby</button>
                <button onclick="restartGame()">Play Again</button>
                <button onclick="window.location.href='/'">New Game</button>
            </div>
        </div>

        <!-- Waiting Screen -->
        <div id="waiting-screen" class="hidden">
            <div class="waiting-screen">
                <div class="waiting-spinner"></div>
                <h2>Waiting for the next round...</h2>
                <p>You'll be added to the game when the next round starts!</p>
            </div>
        </div>
    </div>

    <!-- Player List Panel -->
    <button class="player-list-toggle" id="player-list-toggle" aria-label="Show player list">üë•</button>
    <div id="player-list-panel" class="player-list-panel">
        <h2>Players & Scores</h2>
        <div class="panel-description">Current standings and player status</div>
        <ul id="player-score-list" class="player-score-list">
            <!-- Player list will be populated here -->
        </ul>
    </div>

    <!-- Kick Player Confirmation Modal -->
    <div id="confirmation-modal-overlay" class="modal-overlay">
        <div class="confirmation-modal">
            <h3>Kick Player?</h3>
            <p id="kick-confirmation-message">Are you sure you want to kick this player?</p>
            <div class="modal-buttons">
                <button id="confirm-kick" class="confirm-kick">Yes, Kick Player</button>
                <button id="cancel-kick" class="cancel-kick">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load Socket.IO first - must be non-module for global availability -->
    <script src="{{ versioned_static('socket.io.min.js') }}"></script>
    
    <!-- Non-module scripts (can access global socket variable) -->
    <script src="{{ versioned_static('js/image-loading-optimizer.js') }}"></script>
    <script src="{{ versioned_static('js/cache-buster.js') }}"></script>
    
    <!-- Module scripts with proper imports -->
    <script src="{{ versioned_static('js/game-state.js') }}" type="module"></script>
    <script src="{{ versioned_static('js/progress-tracker.js') }}" type="module"></script>
    <script src="{{ versioned_static('js/image-utils.js') }}" type="module"></script>
    <script src="{{ versioned_static('js/game-core.js') }}" type="module"></script>
    <script src="{{ versioned_static('js/socket-handlers.js') }}" type="module"></script>
    <script src="{{ versioned_static('js/connection-handlers.js') }}" type="module"></script>
    <script src="{{ versioned_static('js/connection-monitoring.js') }}" type="module"></script>
    <script src="{{ versioned_static('js/ui-handlers.js') }}" type="module"></script>
    <script src="{{ versioned_static('js/player-list-panel.js') }}" type="module"></script>
    <script src="{{ versioned_static('js/socket-handlers/game-end-handlers.js') }}" type="module"></script>
    <script src="{{ versioned_static('js/visual-hierarchy.js') }}" type="module"></script>
    
    <!-- Version number (inconspicuous) -->
    <div id="version-number" style="font-size: 10px; color: #ccc; text-align: center; margin-top: 20px; position: fixed; bottom: 5px; right: 10px;">v{{ version }}</div>
</body>

</html>